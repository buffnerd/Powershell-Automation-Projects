<?xml version="1.0" encoding="UTF-8"?>
<Sysmon schemaversion="4.40">
  <HashAlgorithms>md5,sha256</HashAlgorithms>
  <CheckRevocation/>
  <EventFiltering>
    <!-- Event ID 8: CreateRemoteThread - Process Injection Detection -->
    <RuleGroup name="" groupRelation="or">
      <CreateRemoteThread onmatch="include">
        <!-- Monitor all CreateRemoteThread calls for potential injection -->
        <SourceImage condition="not end with">csrss.exe</SourceImage>
        <SourceImage condition="not end with">wininit.exe</SourceImage>
        <SourceImage condition="not end with">winlogon.exe</SourceImage>
        <SourceImage condition="not end with">services.exe</SourceImage>
        <SourceImage condition="not end with">lsass.exe</SourceImage>
        <SourceImage condition="not end with">smss.exe</SourceImage>
        
        <!-- Exclude common legitimate system processes -->
        <SourceImage condition="not contains">\Windows\System32\</SourceImage>
        <SourceImage condition="not contains">\Windows\SysWOW64\</SourceImage>
        
        <!-- Focus on suspicious source processes -->
        <SourceImage condition="end with">powershell.exe</SourceImage>
        <SourceImage condition="end with">cmd.exe</SourceImage>
        <SourceImage condition="end with">wscript.exe</SourceImage>
        <SourceImage condition="end with">cscript.exe</SourceImage>
        <SourceImage condition="end with">mshta.exe</SourceImage>
        <SourceImage condition="end with">rundll32.exe</SourceImage>
        <SourceImage condition="end with">regsvr32.exe</SourceImage>
        <SourceImage condition="end with">certutil.exe</SourceImage>
        <SourceImage condition="end with">bitsadmin.exe</SourceImage>
        
        <!-- Monitor injection into critical processes -->
        <TargetImage condition="end with">explorer.exe</TargetImage>
        <TargetImage condition="end with">winlogon.exe</TargetImage>
        <TargetImage condition="end with">csrss.exe</TargetImage>
        <TargetImage condition="end with">lsass.exe</TargetImage>
        <TargetImage condition="end with">svchost.exe</TargetImage>
      </CreateRemoteThread>
    </RuleGroup>

    <!-- Event ID 10: ProcessAccess - Process Memory Access -->
    <RuleGroup name="" groupRelation="or">
      <ProcessAccess onmatch="include">
        <!-- Monitor process access with write permissions -->
        <GrantedAccess condition="contains">0x1F0FFF</GrantedAccess> <!-- PROCESS_ALL_ACCESS -->
        <GrantedAccess condition="contains">0x1FFFFF</GrantedAccess> <!-- PROCESS_ALL_ACCESS -->
        <GrantedAccess condition="contains">0x143A</GrantedAccess>   <!-- Common injection access -->
        <GrantedAccess condition="contains">0x1410</GrantedAccess>   <!-- PROCESS_QUERY_INFORMATION | PROCESS_VM_READ -->
        <GrantedAccess condition="contains">0x1438</GrantedAccess>   <!-- PROCESS_VM_OPERATION | PROCESS_VM_WRITE -->
        
        <!-- Monitor access to critical system processes -->
        <TargetImage condition="end with">lsass.exe</TargetImage>
        <TargetImage condition="end with">winlogon.exe</TargetImage>
        <TargetImage condition="end with">csrss.exe</TargetImage>
        <TargetImage condition="end with">services.exe</TargetImage>
        <TargetImage condition="end with">smss.exe</TargetImage>
        <TargetImage condition="end with">wininit.exe</TargetImage>
        
        <!-- Monitor suspicious source processes -->
        <SourceImage condition="end with">powershell.exe</SourceImage>
        <SourceImage condition="end with">cmd.exe</SourceImage>
        <SourceImage condition="end with">wscript.exe</SourceImage>
        <SourceImage condition="end with">cscript.exe</SourceImage>
        <SourceImage condition="end with">mshta.exe</SourceImage>
        <SourceImage condition="end with">rundll32.exe</SourceImage>
        <SourceImage condition="end with">regsvr32.exe</SourceImage>
        
        <!-- Monitor uncommon call traces -->
        <CallTrace condition="contains">UNKNOWN</CallTrace>
        <CallTrace condition="contains">Unbacked</CallTrace>
      </ProcessAccess>
    </RuleGroup>

    <!-- Event ID 7: ImageLoad - DLL Injection Detection -->
    <RuleGroup name="" groupRelation="or">
      <ImageLoad onmatch="include">
        <!-- Monitor loading of injection-related libraries -->
        <ImageLoaded condition="end with">kernel32.dll</ImageLoaded>
        <ImageLoaded condition="end with">ntdll.dll</ImageLoaded>
        <ImageLoaded condition="end with">kernelbase.dll</ImageLoaded>
        
        <!-- Monitor unsigned DLLs loaded into system processes -->
        <Image condition="end with">explorer.exe</Image>
        <Image condition="end with">svchost.exe</Image>
        <Image condition="end with">dllhost.exe</Image>
        <Signed condition="is">false</Signed>
        
        <!-- Monitor DLLs loaded from unusual locations -->
        <ImageLoaded condition="contains">\Temp\</ImageLoaded>
        <ImageLoaded condition="contains">\Users\</ImageLoaded>
        <ImageLoaded condition="contains">\AppData\</ImageLoaded>
        <ImageLoaded condition="contains">\ProgramData\</ImageLoaded>
        
        <!-- Monitor hollow process execution -->
        <Image condition="end with">svchost.exe</Image>
        <Image condition="end with">explorer.exe</Image>
        <Image condition="end with">winlogon.exe</Image>
        <ImageLoaded condition="not contains">\Windows\System32\</ImageLoaded>
        <ImageLoaded condition="not contains">\Windows\SysWOW64\</ImageLoaded>
      </ImageLoad>
    </RuleGroup>

    <!-- Event ID 1: Process creation - Injection-related processes -->
    <RuleGroup name="" groupRelation="or">
      <ProcessCreate onmatch="include">
        <!-- Monitor processes commonly used for injection -->
        <Image condition="end with">powershell.exe</Image>
        <ParentImage condition="not end with">powershell.exe</ParentImage>
        <ParentImage condition="not end with">powershell_ise.exe</ParentImage>
        <ParentImage condition="not end with">explorer.exe</ParentImage>
        <ParentImage condition="not end with">cmd.exe</ParentImage>
        
        <!-- Monitor reflective DLL loading techniques -->
        <CommandLine condition="contains">System.Reflection.Assembly</CommandLine>
        <CommandLine condition="contains">Load</CommandLine>
        <CommandLine condition="contains">[Reflection.Assembly]</CommandLine>
        
        <!-- Monitor PowerShell injection techniques -->
        <CommandLine condition="contains">Invoke-ReflectivePEInjection</CommandLine>
        <CommandLine condition="contains">Invoke-Shellcode</CommandLine>
        <CommandLine condition="contains">Invoke-DllInjection</CommandLine>
        <CommandLine condition="contains">Get-ProcAddress</CommandLine>
        <CommandLine condition="contains">VirtualAlloc</CommandLine>
        <CommandLine condition="contains">VirtualProtect</CommandLine>
        <CommandLine condition="contains">CreateThread</CommandLine>
        <CommandLine condition="contains">OpenProcess</CommandLine>
        <CommandLine condition="contains">WriteProcessMemory</CommandLine>
        <CommandLine condition="contains">CreateRemoteThread</CommandLine>
        
        <!-- Monitor RunPE and process hollowing -->
        <CommandLine condition="contains">ZwUnmapViewOfSection</CommandLine>
        <CommandLine condition="contains">NtUnmapViewOfSection</CommandLine>
        <CommandLine condition="contains">VirtualAllocEx</CommandLine>
        <CommandLine condition="contains">SetThreadContext</CommandLine>
        <CommandLine condition="contains">ResumeThread</CommandLine>
        
        <!-- Monitor suspicious rundll32 usage -->
        <Image condition="end with">rundll32.exe</Image>
        <CommandLine condition="not contains">shell32.dll</CommandLine>
        <CommandLine condition="not contains">user32.dll</CommandLine>
        <CommandLine condition="not contains">advpack.dll</CommandLine>
        <CommandLine condition="not contains">setupapi.dll</CommandLine>
        
        <!-- Monitor regsvr32 scriptlet injection -->
        <Image condition="end with">regsvr32.exe</Image>
        <CommandLine condition="contains">scrobj.dll</CommandLine>
        <CommandLine condition="contains">/u</CommandLine>
        <CommandLine condition="contains">/n</CommandLine>
        <CommandLine condition="contains">/i</CommandLine>
        <CommandLine condition="contains">http</CommandLine>
      </ProcessCreate>
    </RuleGroup>

    <!-- Event ID 3: Network connection - Injection payload delivery -->
    <RuleGroup name="" groupRelation="or">
      <NetworkConnect onmatch="include">
        <!-- Monitor network connections from injection-capable processes -->
        <Image condition="end with">powershell.exe</Image>
        <Image condition="end with">rundll32.exe</Image>
        <Image condition="end with">regsvr32.exe</Image>
        <Image condition="end with">mshta.exe</Image>
        <Image condition="end with">certutil.exe</Image>
        
        <!-- Monitor suspicious destination ports -->
        <DestinationPort condition="is">4444</DestinationPort>
        <DestinationPort condition="is">5555</DestinationPort>
        <DestinationPort condition="is">6666</DestinationPort>
        <DestinationPort condition="is">7777</DestinationPort>
        <DestinationPort condition="is">8888</DestinationPort>
        <DestinationPort condition="is">9999</DestinationPort>
        
        <!-- Monitor connections to known bad IPs or suspicious patterns -->
        <DestinationIp condition="contains">10.0.0</DestinationIp>
        <DestinationIp condition="contains">192.168</DestinationIp>
        <DestinationIp condition="contains">172.16</DestinationIp>
      </NetworkConnect>
    </RuleGroup>

    <!-- Event ID 11: FileCreate - Injection-related file creation -->
    <RuleGroup name="" groupRelation="or">
      <FileCreate onmatch="include">
        <!-- Monitor creation of suspicious files -->
        <TargetFilename condition="contains">\Temp\</TargetFilename>
        <TargetFilename condition="contains">\AppData\Local\Temp\</TargetFilename>
        <TargetFilename condition="contains">\Users\Public\</TargetFilename>
        
        <!-- Monitor DLL drops for injection -->
        <TargetFilename condition="end with">.dll</TargetFilename>
        <TargetFilename condition="end with">.tmp</TargetFilename>
        <TargetFilename condition="end with">.dat</TargetFilename>
        
        <!-- Monitor reflective DLL creation -->
        <Image condition="end with">powershell.exe</Image>
        <Image condition="end with">rundll32.exe</Image>
        <Image condition="end with">regsvr32.exe</Image>
      </FileCreate>
    </RuleGroup>
  </EventFiltering>
</Sysmon>