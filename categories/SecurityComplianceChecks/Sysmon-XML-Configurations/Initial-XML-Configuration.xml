<?xml version="1.0" encoding="UTF-8"?>
<Sysmon schemaversion="4.40">
  <HashAlgorithms>md5,sha256</HashAlgorithms>
  <CheckRevocation/>
  <EventFiltering>
    <!-- Event ID 1: Process creation -->
    <RuleGroup name="" groupRelation="or">
      <ProcessCreate onmatch="include">
        <Image condition="end with">cmd.exe</Image>
        <Image condition="end with">powershell.exe</Image>
        <Image condition="end with">pwsh.exe</Image>
        <Image condition="end with">wscript.exe</Image>
        <Image condition="end with">cscript.exe</Image>
        <Image condition="end with">mshta.exe</Image>
        <Image condition="end with">rundll32.exe</Image>
        <Image condition="end with">regsvr32.exe</Image>
        <Image condition="end with">certutil.exe</Image>
        <Image condition="end with">bitsadmin.exe</Image>
        <Image condition="end with">net.exe</Image>
        <Image condition="end with">net1.exe</Image>
        <Image condition="end with">sc.exe</Image>
        <Image condition="end with">wmic.exe</Image>
        <Image condition="end with">schtasks.exe</Image>
        <ParentImage condition="end with">winword.exe</ParentImage>
        <ParentImage condition="end with">excel.exe</ParentImage>
        <ParentImage condition="end with">powerpnt.exe</ParentImage>
        <ParentImage condition="end with">outlook.exe</ParentImage>
        <ParentImage condition="end with">acrobat.exe</ParentImage>
        <ParentImage condition="end with">acrord32.exe</ParentImage>
      </ProcessCreate>
    </RuleGroup>

    <!-- Event ID 2: File creation time changed -->
    <RuleGroup name="" groupRelation="or">
      <FileCreateTime onmatch="include">
        <TargetFilename condition="contains">\Windows\System32\</TargetFilename>
        <TargetFilename condition="contains">\Windows\SysWOW64\</TargetFilename>
        <TargetFilename condition="contains">\Program Files\</TargetFilename>
        <TargetFilename condition="contains">\Program Files (x86)\</TargetFilename>
      </FileCreateTime>
    </RuleGroup>

    <!-- Event ID 3: Network connection -->
    <RuleGroup name="" groupRelation="or">
      <NetworkConnect onmatch="include">
        <Image condition="end with">cmd.exe</Image>
        <Image condition="end with">powershell.exe</Image>
        <Image condition="end with">pwsh.exe</Image>
        <Image condition="end with">wscript.exe</Image>
        <Image condition="end with">cscript.exe</Image>
        <Image condition="end with">mshta.exe</Image>
        <Image condition="end with">rundll32.exe</Image>
        <Image condition="end with">regsvr32.exe</Image>
        <Image condition="end with">certutil.exe</Image>
        <Image condition="end with">bitsadmin.exe</Image>
        <DestinationPort condition="is">80</DestinationPort>
        <DestinationPort condition="is">443</DestinationPort>
        <DestinationPort condition="is">8080</DestinationPort>
        <DestinationPort condition="is">8443</DestinationPort>
      </NetworkConnect>
    </RuleGroup>

    <!-- Event ID 7: Image loaded -->
    <RuleGroup name="" groupRelation="or">
      <ImageLoad onmatch="include">
        <ImageLoaded condition="contains">kernel32.dll</ImageLoaded>
        <ImageLoaded condition="contains">ntdll.dll</ImageLoaded>
        <ImageLoaded condition="contains">advapi32.dll</ImageLoaded>
        <ImageLoaded condition="contains">user32.dll</ImageLoaded>
      </ImageLoad>
    </RuleGroup>

    <!-- Event ID 8: CreateRemoteThread -->
    <RuleGroup name="" groupRelation="or">
      <CreateRemoteThread onmatch="include">
        <SourceImage condition="end with">powershell.exe</SourceImage>
        <SourceImage condition="end with">cmd.exe</SourceImage>
        <SourceImage condition="end with">wscript.exe</SourceImage>
        <SourceImage condition="end with">cscript.exe</SourceImage>
        <SourceImage condition="end with">mshta.exe</SourceImage>
        <SourceImage condition="end with">rundll32.exe</SourceImage>
      </CreateRemoteThread>
    </RuleGroup>

    <!-- Event ID 11: FileCreate -->
    <RuleGroup name="" groupRelation="or">
      <FileCreate onmatch="include">
        <TargetFilename condition="contains">\Windows\Temp\</TargetFilename>
        <TargetFilename condition="contains">\Temp\</TargetFilename>
        <TargetFilename condition="contains">\AppData\Local\Temp\</TargetFilename>
        <TargetFilename condition="end with">.exe</TargetFilename>
        <TargetFilename condition="end with">.dll</TargetFilename>
        <TargetFilename condition="end with">.bat</TargetFilename>
        <TargetFilename condition="end with">.cmd</TargetFilename>
        <TargetFilename condition="end with">.ps1</TargetFilename>
        <TargetFilename condition="end with">.vbs</TargetFilename>
        <TargetFilename condition="end with">.js</TargetFilename>
        <TargetFilename condition="end with">.jar</TargetFilename>
        <TargetFilename condition="end with">.scr</TargetFilename>
      </FileCreate>
    </RuleGroup>

    <!-- Event ID 12: RegistryEvent (Object create and delete) -->
    <RuleGroup name="" groupRelation="or">
      <RegistryEvent onmatch="include">
        <TargetObject condition="contains">HKLM\SOFTWARE\Microsoft\Windows\CurrentVersion\Run</TargetObject>
        <TargetObject condition="contains">HKCU\SOFTWARE\Microsoft\Windows\CurrentVersion\Run</TargetObject>
        <TargetObject condition="contains">HKLM\SOFTWARE\Microsoft\Windows\CurrentVersion\RunOnce</TargetObject>
        <TargetObject condition="contains">HKCU\SOFTWARE\Microsoft\Windows\CurrentVersion\RunOnce</TargetObject>
        <TargetObject condition="contains">HKLM\SOFTWARE\WOW6432Node\Microsoft\Windows\CurrentVersion\Run</TargetObject>
        <TargetObject condition="contains">HKCU\SOFTWARE\WOW6432Node\Microsoft\Windows\CurrentVersion\Run</TargetObject>
        <TargetObject condition="contains">HKLM\SYSTEM\CurrentControlSet\Services</TargetObject>
        <TargetObject condition="contains">HKLM\SOFTWARE\Microsoft\Windows NT\CurrentVersion\Winlogon</TargetObject>
      </RegistryEvent>
    </RuleGroup>

    <!-- Event ID 13: RegistryEvent (Value Set) -->
    <RuleGroup name="" groupRelation="or">
      <RegistryEvent onmatch="include">
        <TargetObject condition="contains">HKLM\SOFTWARE\Microsoft\Windows\CurrentVersion\Run</TargetObject>
        <TargetObject condition="contains">HKCU\SOFTWARE\Microsoft\Windows\CurrentVersion\Run</TargetObject>
        <TargetObject condition="contains">HKLM\SOFTWARE\Microsoft\Windows\CurrentVersion\RunOnce</TargetObject>
        <TargetObject condition="contains">HKCU\SOFTWARE\Microsoft\Windows\CurrentVersion\RunOnce</TargetObject>
        <TargetObject condition="contains">HKLM\SOFTWARE\WOW6432Node\Microsoft\Windows\CurrentVersion\Run</TargetObject>
        <TargetObject condition="contains">HKCU\SOFTWARE\WOW6432Node\Microsoft\Windows\CurrentVersion\Run</TargetObject>
        <TargetObject condition="contains">HKLM\SYSTEM\CurrentControlSet\Control\SecurityProviders</TargetObject>
        <TargetObject condition="contains">HKLM\SOFTWARE\Microsoft\Windows NT\CurrentVersion\Winlogon</TargetObject>
      </RegistryEvent>
    </RuleGroup>

    <!-- Event ID 15: FileCreateStreamHash -->
    <RuleGroup name="" groupRelation="or">
      <FileCreateStreamHash onmatch="include">
        <TargetFilename condition="end with">.exe</TargetFilename>
        <TargetFilename condition="end with">.dll</TargetFilename>
        <TargetFilename condition="end with">.bat</TargetFilename>
        <TargetFilename condition="end with">.cmd</TargetFilename>
        <TargetFilename condition="end with">.ps1</TargetFilename>
        <TargetFilename condition="end with">.vbs</TargetFilename>
        <TargetFilename condition="end with">.js</TargetFilename>
      </FileCreateStreamHash>
    </RuleGroup>

    <!-- Event ID 17: PipeEvent (Pipe Created) -->
    <RuleGroup name="" groupRelation="or">
      <PipeEvent onmatch="include">
        <PipeName condition="contains">MSSQL</PipeName>
        <PipeName condition="contains">sql\query</PipeName>
        <PipeName condition="contains">SQLLocal</PipeName>
        <PipeName condition="contains">winreg</PipeName>
        <PipeName condition="contains">spoolss</PipeName>
        <PipeName condition="contains">netlogon</PipeName>
        <PipeName condition="contains">lsarpc</PipeName>
        <PipeName condition="contains">samr</PipeName>
      </PipeEvent>
    </RuleGroup>

    <!-- Event ID 22: DNSEvent (DNS query) -->
    <RuleGroup name="" groupRelation="or">
      <DnsQuery onmatch="include">
        <QueryName condition="end with">.exe</QueryName>
        <QueryName condition="end with">.dll</QueryName>
        <QueryName condition="end with">.bat</QueryName>
        <QueryName condition="end with">.ps1</QueryName>
        <QueryName condition="contains">bit.ly</QueryName>
        <QueryName condition="contains">tinyurl</QueryName>
        <QueryName condition="contains">pastebin</QueryName>
        <QueryName condition="contains">paste.ee</QueryName>
        <QueryName condition="contains">raw.githubusercontent</QueryName>
      </DnsQuery>
    </RuleGroup>
  </EventFiltering>
</Sysmon>